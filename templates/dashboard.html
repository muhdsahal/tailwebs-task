<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Teacher Portal - Dashboard</title>
    <link rel="stylesheet" href="/static/style.css" />
  </head>
  <body>
    <div class="dashboard-container">
      <header class="dashboard-header">
        <h1 class="heading-title">tailwebs.</h1>
        <div class="header-info">
          <span>Home</span>
          <span  onclick="logout()">Logout</span>
        </div>
      </header>

      <main class="dashboard-main">
        <div class="controls">
          <button onclick="openAddStudentModal()" class="add-student-btn">
            Add New Student
          </button>
          <button onclick="loadStudents()" class="refresh-btn">Refresh</button>
        </div>

        <div class="students-table-container">
          <table id="students-table" class="students-table">
            <thead>
              <tr>  
                <th>Name</th>
                <th>Subject</th>
                <th>Marks</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="students-tbody">
            </tbody>
          </table>
          <div id="no-students" class="no-students" style="display: none">
            <p>No students found. Click "Add New Student" to get started.</p>
          </div>
        </div>
      </main>
    </div>

    <div id="add-student-modal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeAddStudentModal()">&times;</span>
        <h2>Add New Student</h2>
        <form id="add-student-form">
          <div class="input-group">
            <label for="student-name">Student Name:</label>
            <input type="text" id="student-name" name="name" required />
          </div>
          <div class="input-group">
            <label for="student-subject">Subject:</label>
            <input type="text" id="student-subject" name="subject" required />
          </div>
          <div class="input-group">
            <label for="student-marks">Marks:</label>
            <input
              type="number"
              id="student-marks"
              name="marks"
              min="0"
              max="100"
              required
            />
          </div>
          <button type="submit" class="submit-btn">Add Student</button>
        </form>
      </div>
    </div>

    <div id="edit-student-modal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeEditStudentModal()">&times;</span>
        <h2>Edit Student</h2>
        <form id="edit-student-form">
          <input type="hidden" id="edit-student-id" />
          <div class="input-group">
            <label for="edit-student-name">Student Name:</label>
            <input type="text" id="edit-student-name" name="name" required />
          </div>
          <div class="input-group">
            <label for="edit-student-subject">Subject:</label>
            <input
              type="text"
              id="edit-student-subject"
              name="subject"
              required
            />
          </div>
          <div class="input-group">
            <label for="edit-student-marks">Marks:</label>
            <input
              type="number"
              id="edit-student-marks"
              name="marks"
              min="0"
              max="100"
              required
            />
          </div>
          <button type="submit" class="submit-btn">Update Student</button>
        </form>
      </div>
    </div>

    <div id="message" class="message"></div>

    <script src="/static/script.js"></script>
    <script>
      let currentTeacher = null;

      document.addEventListener("DOMContentLoaded", function () {
        const teacherData = sessionStorage.getItem("teacher");
        if (!teacherData) {
          window.location.href = "/login";
          return;
        }

        currentTeacher = JSON.parse(teacherData);
        document.getElementById(
          "teacher-name"
        ).textContent = `Welcome, ${currentTeacher.name}`;
        loadStudents();
      });

      async function loadStudents() {
        try {
          const response = await fetch("/api/students", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ teacher_id: currentTeacher.id }),
          });

          const data = await response.json();

          if (data.success) {
            displayStudents(data.students);
          } else {
            showMessage("Error loading students: " + data.message, "error");
          }
        } catch (error) {
          showMessage("Error loading students", "error");
        }
      }

      function displayStudents(students) {
        const tbody = document.getElementById("students-tbody");
        const noStudentsDiv = document.getElementById("no-students");

        if (students.length === 0) {
          tbody.innerHTML = "";
          noStudentsDiv.style.display = "block";
          return;
        }

        noStudentsDiv.style.display = "none";

        tbody.innerHTML = students
          .map(
            (student) => `
                <tr>
                    <td>
            <div class="student-name-cell">
                <span class="avatar">${student.name
                  .charAt(0)
                  .toUpperCase()}</span>
                ${student.name}
            </div>
                    </td>
                    <td>${student.subject}</td>
                    <td>${student.marks}</td>
                    <td>
                        <button onclick="editStudent(${student.id}, '${
              student.name
            }', '${student.subject}', ${
              student.marks
            })" class="edit-btn">Edit</button>
                        <button onclick="deleteStudent(${
                          student.id
                        })" class="delete-btn">Delete</button>
                    </td>
                </tr>
            `
          )
          .join("");
      }

      document
        .getElementById("add-student-form")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          const formData = new FormData(e.target);
          const studentData = {
            name: formData.get("name"),
            subject: formData.get("subject"),
            marks: parseInt(formData.get("marks")),
            teacher_id: currentTeacher.id,
          };

          try {
            const response = await fetch("/api/add_student", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(studentData),
            });

            const data = await response.json();

            if (data.success) {
              showMessage(data.message, "success");
              closeAddStudentModal();
              loadStudents();
            } else {
              showMessage("Error adding student: " + data.message, "error");
            }
          } catch (error) {
            showMessage("Error adding student", "error");
          }
        });

      document
        .getElementById("edit-student-form")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          const formData = new FormData(e.target);
          const studentData = {
            student_id: parseInt(
              document.getElementById("edit-student-id").value
            ),
            name: formData.get("name"),
            subject: formData.get("subject"),
            marks: parseInt(formData.get("marks")),
          };

          try {
            const response = await fetch("/api/update_student", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(studentData),
            });

            const data = await response.json();

            if (data.success) {
              showMessage(data.message, "success");
              closeEditStudentModal();
              loadStudents();
            } else {
              showMessage("Error updating student: " + data.message, "error");
            }
          } catch (error) {
            showMessage("Error updating student", "error");
          }
        });

      async function deleteStudent(studentId) {
        if (!confirm("Are you sure you want to delete this student?")) {
          return;
        }

        try {
          const response = await fetch("/api/delete_student", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ student_id: studentId }),
          });

          const data = await response.json();

          if (data.success) {
            showMessage(data.message, "success");
            loadStudents();
          } else {
            showMessage("Error deleting student: " + data.message, "error");
          }
        } catch (error) {
          showMessage("Error deleting student", "error");
        }
      }

      function openAddStudentModal() {
        document.getElementById("add-student-modal").style.display = "block";
        document.getElementById("add-student-form").reset();
      }

      function closeAddStudentModal() {
        document.getElementById("add-student-modal").style.display = "none";
      }

      function editStudent(id, name, subject, marks) {
        document.getElementById("edit-student-id").value = id;
        document.getElementById("edit-student-name").value = name;
        document.getElementById("edit-student-subject").value = subject;
        document.getElementById("edit-student-marks").value = marks;
        document.getElementById("edit-student-modal").style.display = "block";
      }

      function closeEditStudentModal() {
        document.getElementById("edit-student-modal").style.display = "none";
      }

      window.onclick = function (event) {
        const addModal = document.getElementById("add-student-modal");
        const editModal = document.getElementById("edit-student-modal");

        if (event.target === addModal) {
          closeAddStudentModal();
        }
        if (event.target === editModal) {
          closeEditStudentModal();
        }
      };

      function logout() {
        sessionStorage.removeItem("teacher");
        window.location.href = "/login";
      }

      function showMessage(message, type) {
        const messageDiv = document.getElementById("message");
        messageDiv.textContent = message;
        messageDiv.className = `message ${type}`;
        messageDiv.style.display = "block";

        setTimeout(() => {
          messageDiv.style.display = "none";
        }, 3000);
      }
    </script>
  </body>
</html>
